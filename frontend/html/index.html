<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./../static/home.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Canteen Feedback</title>
</head>

<body>
    <div id="alert_box" class="fixed top-0 left-0 flex-col flex m-2 bg-white opacity-0 w-[20rem]">
        <p class="m-2"></p>
        <div class="h-[5px] w-0 
        bg-green-400 transition-all duration-[4s]"></div>
    </div>

    <header class="flex-header">
        <img src="./../static/raman.jpeg" alt="Avatar" class="hedear-img h-[60px]">
        <div class="flex items-center">
            {% if user.type==1 or user.type ==2 %}
            <a href="{{url_for('admin')}}" class="review-button">Admin</a>
            {% endif %}
            <a href="{{url_for('get_review')}}"><button class="review-button">Write a Review</button></a>
            {% if user.is_authenticated %}
            <a href="{{url_for('logout')}}"><button class="review-button">Logout</button></a>
            <div class="avatar">
                <img src={{user.profile_url}} alt="Avatar">
            </div>
            {% else %}
            <a href="{{url_for('login')}}"><button class="review-button">Login</button></a>
            {% endif %}
        </div>
    </header>
    <div class="content">
        <section class="main-content" style="flex: 3;">
            <div class="search-container">
                <input type="text" placeholder="Search for your canteen..." id="search_item">
                <button class="search-button" onclick="search()" class="hover:cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none" />
                        <path
                            d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.76-2.86-5-5.64-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.78 2.58 5.17 5.34 5.64a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25a1 1 0 0 0 1.41-1.41L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                </button>
            </div>
            <div class="dropdown" id="searchDropdown">
                <div class="dropdown-content" id="searchResults">
                    <!-- Search results will be displayed here -->
                </div>
            </div>

            <div class="m-5 flex flex-wrap" id="item_tags"></div>
            <div class="hidden h-[200px] list-none w-full p-2" id="item_tags_reviews"></div>

            <div style="width: 100%;" class="answerContent">
                <div class="flex-col items-center gap-y-5 w-full" id="item_detail">
                    <div style="display: flex; flex-wrap: wrap;justify-content: center;">
                        <div class="chart-container" style="width: 65%;">
                            <canvas id="lineplot"></canvas>
                        </div>
                        <div class="chart-container" style="width: 20rem;">
                            <canvas id="myPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </section>
        <section style="flex:1.4;" class="sidebar w-fit">
            <div class="chart-container" style="position: relative; display: flex; justify-content: center;">
                <canvas id="myChart"></canvas>
            </div>
            <div class="hot-topics flex-col gap-y-2">
                <ul>
                    {% if not user.is_authenticated %}
                    <h2>Recommended items</h2>
                    {% else %}
                    <h2>Recommended for you</h2>
                    {% endif %}

                    {% if recommend_items is not none %}

                    {% for item in recommend_items %}
                    <li>{{item}}</li>
                    {% endfor %}
                    {%endif%}
                </ul>
            </div>
        </section>
    </div>
    <footer>
        <p>&copy; Milan Hackthon 2023 From Raman Block</p>
    </footer>
</body>
<script type="text/javascript">
    // for showing alert
    showAlert = (msg) => {
        alert_box.firstElementChild.innerText = msg;
        alert_box.classList.replace("opacity-0", "opacity-100");
        alert_box.firstElementChild.nextElementSibling.classList.add("w-full");


        setTimeout(() => {
            alert_box.classList.replace("opacity-100", "opacity-0");
            alert_box.firstElementChild.nextElementSibling.classList.remove("w-full")
        }, 4000)
    }

    message = "{{ messages }}"
    if (message !== "None") {
        showAlert(message)
    }

    positive_reviews = []
    negative_reviews = []
    item_line_chart = [1]
    rating_pie_chart = 1
    rating_array = 1
    curr_search_value = ""
    search_item = document.getElementById("search_item")
    let canva = document.getElementsByClassName("canva")
    positive_list = document.getElementById("positive_review_list")
    negative_list = document.getElementById("negative_review_list")
    item_tags = document.getElementById("item_tags")
    item_tags_reviews = document.getElementById("item_tags_reviews")
    canva.width = 400
    canva.height = 300
    is_tag_clicked = false

    var item_list = {{ item_list | safe}}


    function jaccardSimilarity(word1, word2) {
        var max_common = 0, curr = 0;

        for (let i = 0; i < (word2.length - word1.length + 1); i++) {
            curr = 0;
            console.log(curr)
            for (let j = 0; j < word1.length; j++) {
                if (word1[j] === word2[i + j]) curr++;
            }
            max_common = Math.max(max_common, curr)
        }
        console.log(max_common)
        return max_common / word1.length
    }


    data = []
    search_item.addEventListener("keyup", () => {
        curr_search_value = search_item.value
        data = []
        for (let i = 0; i < item_list.length; i++) {
            similarity = jaccardSimilarity(search_item.value, item_list[i])
            if (similarity > .5) {
                data.push(item_list[i])
            }
        }
        const searchResults = document.getElementById("searchResults");
        searchResults.innerHTML = ""

        if (data.length > 0) {
            data.forEach(item => {
                const result = document.createElement("a");
                result.textContent = item;
                result.addEventListener("click", () => {
                    search_item.value = item
                    document.getElementById("searchResults").style.display = "none";
                    search();
                })
                searchResults.appendChild(result);
            });
            searchResults.style.display = "block"
        }
    })

    function search() {
        const searchTerm = document.getElementById("search_item").value.toLowerCase();

        if (item_list.indexOf(searchTerm) === -1) {
            showAlert("Item not present")
        }

        $.ajax({
            type: "POST",
            url: "/search",
            data: JSON.stringify([{ "item_name": searchTerm }]),
            contentType: "application/json",
            dataType: 'json',
            success: function (result) {
                console.log(result)
                item_tags_list = ["test", "test2", "tskjddskjd", "test", "test2", "tskjddskjd", "test", "test2", "tskjddskjd", "test", "test2", "tskjddskjd"]
                item_tags_list = Object.keys(result[3])
                item_tags_reviews_list = { "test": ["1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa", "1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa", "1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa", "1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa"], "test2": ["1,jdsljsfdsaf", "lkskjdklsa"], "tskjddskjd": ["1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa", "1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa", "1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa", "1,jdsljsfdsaf", "lkskjdklsadjkasjdojdsadsa"] }

                item_tags_reviews_list = result[3]

                summary = result[4]

                for (let i = 0; i < item_tags_list.length; i++) {
                    li = document.createElement("li")
                    li.textContent = item_tags_list[i]
                    li.classList.add("inline", "bg-gray-100", "m-1", "p-1", "rounded", "hover:cursor-pointer")
                    item_tags.appendChild(li)

                    li.addEventListener("click", () => {
                        if (!is_tag_clicked) {
                            item_tags_reviews.classList.replace("hidden", "block")
                            curr_reviews = item_tags_reviews_list[li.textContent];
                            for (let j = 0; j < curr_reviews.length; j++) {
                                li2 = document.createElement("li");
                                li2.textContent = curr_reviews[j];
                                item_tags_reviews.appendChild(li2)
                                li2.classList.add("bg-gray-200", "m-1", "p-1", "rounded", "w-fit")
                            }
                            is_tag_clicked = !is_tag_clicked
                        }
                        else {
                            item_tags_reviews.classList.replace("block", "hidden")
                            item_tags_reviews.innerHTML = '';
                            is_tag_clicked = !is_tag_clicked
                        }

                    })
                }

                positive_reviews = result[1].split(',')
                negative_reviews = result[2].split(',')

                curr_search_value = searchTerm

                console.log(result)

                rating_array = result[0]

                var d = new Date();
                d.setDate(d.getDate() - 1);

                date = []
                var d = new Date();
                for (let i = 0; i < rating_array.length; i++) {
                    d.setDate(d.getDate() - 1)
                    date.push(d.getDate().toString() + " " + d.toLocaleString("en-US", { month: "short" }).toString())
                }
                date.reverse()
                if (item_line_chart != 1) {
                    item_line_chart.destroy()
                }
                item_line_chart = creatLineChart(date, rating_array, item);

                n_ratings = { 'Positive': positive_reviews.length, 'Negative': negative_reviews.length };
                if (rating_pie_chart != 1) {
                    rating_pie_chart.destroy()
                }
                rating_pie_chart = DrawPieChart(n_ratings);


                // positive_list.innerHTML = '';
                // negative_list.innerHTML = '';
                // for (let i = 0; i < positive_reviews.length; i++) {

                //     li = document.createElement('li')
                //     li.style.margin = "2px 5px"
                //     li.style.height = "fit-content"
                //     li.textContent = positive_reviews[i]
                //     positive_list.appendChild(li)
                // }

                // for (let i = 0; i < negative_reviews.length; i++) {


                //     li = document.createElement('li')
                //     li.style.margin = "2px 5px"
                //     li.style.height = "fit-content"
                //     li.textContent = negative_reviews[i]
                //     negative_list.appendChild(li)
                // }

                // item_detail = document.getElementById("review_list")
                // item_detail.classList.replace("hidden", "flex")
            }
        });

    }

    document.getElementById("search_item").addEventListener("keypress", send_item);
    function send_item(event) {

        if (event.key == "Enter") {
            search();
        }
    }


    var item = curr_search_value;

    function creatLineChart(x, y, item) {
        var ctx = document.getElementById('lineplot').getContext('2d');

        const barColors = ["red", "green", "blue", "orange", "brown"];
        var lineplot = new Chart("lineplot", {
            type: "line",
            data: {
                labels: x,
                datasets: [{
                    label: 'Rating',
                    fill: false,
                    lineTension: 0,
                    backgroundColor: "#9681EB",
                    borderColor: "#6527BE",
                    data: y
                }]
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Variation of average rating in last 16 days',
                        fontSize: 30
                    }
                },
                legend: { display: false },
                scales: {
                    y: {
                        beginAtZero: true,
                        suggestedMin: 0,
                        suggestedMax: 5
                    },
                    yAxes: [{ ticks: { min: 6, max: 16 } }],
                }
            }
        });
        return lineplot
    }

    // JSON data
    var jsonData = {{ top5| safe }};

    // Function to create a bar chart
    function createBarChart(data) {
        var ctx = document.getElementById('myChart').getContext('2d');
        var labels = Object.keys(data);
        var values = Object.values(data);

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ratings',
                    data: values,
                    backgroundColor: '#9681EB', // Bar color
                    borderColor: '#6527BE', // Border color
                    borderWidth: 2
                }],

            },
            options: {
                plugins: {
                    title: {
                        display: true, // Display the title
                        text: 'Average ratings of Top 5 Food Items in the last week', // Title text
                        fontSize: 30 // Font size for the title
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            fontSize: 25 // Increase the font size for x-axis labels
                        }
                    },
                    y: {
                        beginAtZero: true,
                        suggestedMin: 0,
                        suggestedMax: 5
                    }
                }
            }
        });
    }
    createBarChart(jsonData);


    function DrawPieChart(jsondata) {
        var plotvalues = Object.values(jsondata);
        var allLabels = Object.keys(jsondata);

        // Get a reference to the canvas element
        var ctx = document.getElementById('myPieChart').getContext('2d');

        // Define the data for the pie chart
        var data = {
            labels: allLabels,
            datasets: [{
                data: plotvalues, // The data values for each segment
                backgroundColor: ['green', 'red'], // The colors for each segment
            }]
        };

        // Create the pie chart
        var myPieChart = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                legend: { display: false },
                plugins: {
                    title: {
                        display: true, // Display the title
                        text: 'Count of positive and negative points in all reviews', // Title text
                        fontSize: 30 // Font size for the title
                    }
                },

                devicePixelRatio: 2, // Increase the device pixel ratio for better quality
                scales: {

                }
            }
        })
        return myPieChart
    };

</script>

</html>