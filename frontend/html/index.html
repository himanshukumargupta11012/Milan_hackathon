<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./../static/home.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Canteen Feedback</title>
</head>

<body>
    <div id="alert_box" class="fixed top-0 left-0 flex-col flex m-2 bg-white opacity-0 w-[20rem]">
        <p class="m-2"></p>
        <div class="h-[5px] w-0 
        bg-green-400 transition-all duration-[4s]"></div>
    </div>

    <header class="flex-header">
        <img src="./../static/raman.jpeg" alt="Avatar" width="50" height="50" class="hedear-img">
        <div class="flex items-center">
            <a href="{{url_for('get_review')}}"><button class="review-button">Write a Review</button></a>
            {% if user.is_authenticated %}
            <a href="{{url_for('logout')}}"><button class="review-button">Logout</button></a>
            <div class="avatar">
                <img src={{user.profile_url}} alt="Avatar">
            </div>
            {% else %}
            <a href="{{url_for('login')}}"><button class="review-button">Login</button></a>
            {% endif %}
        </div>

    </header>
    <div class="content">
        <section class="main-content" style="flex: 3;">
            <div class="search-container">
                <input type="text" placeholder="Search for your canteen..." id="search_item">
                <button class="search-button" onclick="search()" class="hover:cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none" />
                        <path
                            d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.76-2.86-5-5.64-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.78 2.58 5.17 5.34 5.64a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25a1 1 0 0 0 1.41-1.41L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                </button>
            </div>
            <div class="dropdown" id="searchDropdown">
                <div class="dropdown-content" id="searchResults">
                    <!-- Search results will be displayed here -->
                </div>
            </div>

            <!-- canva for drawing the graphs -->
            <div class="flex-col items-center gap-y-5 w-full" id="item_detail">
                <div style="display: flex;">
                    <div class="chart-container" style="position: relative;  width: 500px;">
                        <canvas id="lineplot"></canvas>
                    </div>
                    <div class="chart-container" style="position: relative;  width: 500px;">
                        <canvas id="myPieChart" width="200" height="200"></canvas>
                    </div>
                </div>
                

                <div class="flex justify-evenly w-full h-[300px] overflow-y-scroll" id="review_list">

                    <div id="positive_review_list" class="list-none">
                        <h2 class="text-xl">Positive Feedback</h2>
                    </div>

                    <div id="negative_review_list" class="list-none">
                        <h2 class="text-xl">Negative Feedback</h2>
                    </div>
                </div>

            </div>

        </section>
        <section style="flex:1.4;" class="sidebar">
            <div class="chart-container" style="position: relative; display: flex; justify-content: center;">
                <canvas id="myChart"></canvas>
            </div>
            <div class="hot-topics flex-col gap-y-2">
                <ul>
                    <h2>Recommended for you</h2>
                    <li>Non-veg Noodles</li>
                    <li>Veg Noodles</li>
                    <li>Maggi</li>
                    <li>Panipuri</li>
                    <li>Sandwich</li>
                    <li>Chiken Roll</li>
                    <li>Veg Roll</li>
                    <li>Coffee</li>
                    <li>Ice tea</li>
                    <li>Tea</li>
                    <li>Fruit Juice</li>
                </ul>
            </div>
        </section>
    </div>
    <footer>
        <p>&copy; Milan Hackthon 2023 From Raman Block</p>
    </footer>
</body>
<script type="text/javascript">
    positive_reviews = []
    negative_reviews = []
    search_item = document.getElementById("search_item")
    let canva = document.getElementsByClassName("canva")
    canva.width = 400
    canva.height = 300

    var item_list = {{ item_list | safe}}


    function jaccardSimilarity(word1, word2) {
        const set1 = new Set(word1.split(''));
        const set2 = new Set(word2.split(''));

        const intersection = new Set([...set1].filter(char => set2.has(char)));
        const union = new Set([...set1, ...set2]);

        return intersection.size / union.size;
    }


    data = []
    search_item.addEventListener("keyup", () => {

        data = []
        for (let i = 0; i < item_list.length; i++) {
            similarity = jaccardSimilarity(item_list[i], search_item.value)
            if (similarity > .4) {
                data.push(item_list[i])
            }
        }
        const searchResults = document.getElementById("searchResults");
        searchResults.innerHTML = ""

        if (data.length > 0) {
            data.forEach(item => {
                const result = document.createElement("a");
                result.textContent = item;
                result.addEventListener("click", () => {
                    search2(item);
                })
                searchResults.appendChild(result);
            });
            searchResults.style.display = "block"
        }
    })

    //     const data = [
    //     "Modeling",
    //     "Simulation",
    //     "Machine Learning",
    //     "Control Systems",
    //     "Artificial Intelligence",
    //     "Reinforcement Learning",
    //     "Optimization"
    //     // Add more items as needed
    // ];


    function search() {
        const searchTerm = document.getElementById("search_item").value.toLowerCase();

        if (item_list.indexOf(searchTerm) === -1) {
            showAlert("Item not present")
        }

        $.ajax({
            type: "POST",
            url: "/search",
            data: JSON.stringify([{ "item_name": searchTerm }]),
            contentType: "application/json",
            dataType: 'json',
            success: function (result) {
                console.log(result)
                spac.innerHTML = result.rows[0][1];
            }
        });

        const searchResults = document.getElementById("searchResults");
        searchResults.innerHTML = ""; // Clear previous results

        const filteredData = data.filter(item => item.toLowerCase().includes(searchTerm));

        if (filteredData.length === 0) {
            const noResults = document.createElement("a");
            noResults.textContent = "No results found.";
            searchResults.appendChild(noResults);
        } else {
            filteredData.forEach(item => {
                const result = document.createElement("a");
                result.textContent = item;
                searchResults.appendChild(result);
            });
            searchResults.style.display = "block"
        }
    }

    function search2(item) {
        document.getElementById("searchResults").style.display = "none";
        console.log(document.getElementById("searchResults").style.display)

        const searchTerm = item.toLowerCase();

        if (item_list.indexOf(searchTerm) === -1) {
            showAlert("Item not present")
        }

        $.ajax({
            type: "POST",
            url: "/search",
            data: JSON.stringify([{ "item_name": searchTerm }]),
            contentType: "application/json",
            dataType: 'json',
            success: function (result) {
                // spac.innerHTML = result.rows;
                positive_reviews = result[1].split(',')
                negative_reviews = result[2].split(',')

                console.log(negative_reviews)


                for (let i = 0; i < positive_reviews.length; i++) {
                    positive_list = document.getElementById("positive_review_list")

                    li = document.createElement('li')
                    li.textContent = positive_reviews[i]
                    positive_list.appendChild(li)
                }

                for (let i = 0; i < negative_reviews.length; i++) {
                    negative_list = document.getElementById("negative_review_list")

                    li = document.createElement('li')
                    li.textContent = negative_reviews[i]
                    negative_list.appendChild(li)
                }

                item_detail = document.getElementById("item_detail")
                item_detail.classList.replace("hidden", "flex")

                console.log(positive_reviews)
            }
        });

        const searchResults = document.getElementById("searchResults");
        searchResults.innerHTML = ""; // Clear previous results

        const filteredData = data.filter(item => item.toLowerCase().includes(searchTerm));

        if (filteredData.length === 0) {
            const noResults = document.createElement("a");
            noResults.textContent = "No results found.";
            searchResults.appendChild(noResults);
        } else {
            filteredData.forEach(item => {
                const result = document.createElement("a");
                result.textContent = item;
                searchResults.appendChild(result);
            });
        }
    }

    document.getElementById("search_item").addEventListener("keypress", send_item);
    function send_item(event) {

        if (event.key == "Enter") {
            search();
        }
    }
    // for showing alert
    showAlert = (msg) => {
        alert_box.firstElementChild.innerText = msg;
        alert_box.classList.replace("opacity-0", "opacity-100");
        alert_box.firstElementChild.nextElementSibling.classList.add("w-full");


        setTimeout(() => {
            alert_box.classList.replace("opacity-100", "opacity-0");
            alert_box.firstElementChild.nextElementSibling.classList.remove("w-full")
        }, 4000)
    }

</script>

<script>
    var item = 'Maagi';
    const jsondatalineplot = { '50': 7, '60': 8, '70': 8, '80': 9, '90': 9, '100': 9, '110': 10, '120': 11, '130': 14, '140': 14, '150': 15 }
    function creatLineChart(data, item) {
        var ctx = document.getElementById('lineplot').getContext('2d');
        var xValues = Object.keys(data);
        var yValues = Object.values(data);
        const barColors = ["red", "green", "blue", "orange", "brown"];
        var lineplot = new Chart("lineplot", {
            type: "line",
            data: {
                labels: xValues,
                datasets: [{
                    fill: false,
                    lineTension: 0,
                    backgroundColor: "#9681EB",
                    borderColor: "#6527BE",
                    data: yValues
                }]
            },
            options: {
                legend: { display: false },
                title: {
                    display: true,
                    text: "Rating of " + item + " over last few days"
                },
                legend: { display: false },
                scales: {
                    yAxes: [{ ticks: { min: 6, max: 16 } }],
                }
            }
        });
    }
    creatLineChart(jsondatalineplot, item)
</script>

<!-- Call the function to generate the chart -->
<script>
    // JSON data
    var jsonData = { 'Maggi': 9, 'Veg Noodles': 4, 'Lemon Ice Tea': 7.5, 'Pav Bhaji': 6, 'Pani Puri': 10 };

    // Function to create a bar chart
    function createBarChart(data) {
        var ctx = document.getElementById('myChart').getContext('2d');
        var labels = Object.keys(data);
        var values = Object.values(data);

        var myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ratings',
                    data: values,
                    backgroundColor: '#9681EB', // Bar color
                    borderColor: '#6527BE', // Border color
                    borderWidth: 2
                }],

            },
            options: {
                plugins: {
                    title: {
                        display: true, // Display the title
                        text: 'Ratings of Top 5 Food Items in the last week', // Title text
                        fontSize: 30 // Font size for the title
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            fontSize: 25 // Increase the font size for x-axis labels
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    createBarChart(jsonData);
</script>
<script>
    // fetch from backend to here
    var jsondata = { 'correct': 85, 'wrong': 15 };

    function DrawPieChart(jsondata) {
        var plotvalues = Object.values(jsondata);
        var allLabels = Object.keys(jsondata);

        // Get a reference to the canvas element
        var ctx = document.getElementById('myPieChart').getContext('2d');

        // Define the data for the pie chart
        var data = {
            labels: allLabels,
            datasets: [{
                data: plotvalues, // The data values for each segment
                backgroundColor: ['green', 'red'], // The colors for each segment
            }]
        };

        // Create the pie chart
        var myPieChart = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: {
                legend: { display: false },
                plugins: {
                    title: {
                        display: true, // Display the title
                        text: 'Ratings of Top 5 Food Items in the last week', // Title text
                        fontSize: 30 // Font size for the title
                    }
                },

                devicePixelRatio: 2, // Increase the device pixel ratio for better quality
                scales: {

                }
            }
        })
    };

    DrawPieChart(jsondata);
</script>

</html>